{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Set Checks{% endblock %}</h1> 
{% endblock %}

{% block content %}

{% set nav_prev_page_shown=True %}
{% set nav_prev_page_live=True %}
{% set nav_prev_page_location="/enter_metadata" %}

{% set nav_next_page_shown=False %}
{% set nav_next_page_live=True %}
{% set nav_next_page_location="" %}

{% include 'navigation.html' %}
    
<style>

.run_status_blinking {
animation: animate 1.5s linear infinite; 
}  

.run_status_static {
animation: none; 
}  

@keyframes animate{ 
  0%{ 
    opacity: 0; 
  } 
  50%{ 
    opacity: 0.7; 
  } 
  100%{ 
    opacity: 0; 
  } 
} 
</style> 

{% if setchks_session.setchks_jobs_manager.jobs_running %}
{% if setchks_session.all_CHKXX_finished %}
    {% set progress_status="CREATING_REPORT" %}
{% else %}
    {% set progress_status="CHECKS_RUNNING" %}
{% endif %}
{% else %}
{% if not setchks_session.all_CHKXX_finished %}
    {% set progress_status="CHECKS_READY_TO_RUN" %}
{% else %}
    {% if not setchks_session.excel_file_available %}
        {% set progress_status="CHECKS_COMPLETED"%}
    {% else %}
        {% if not setchks_session.excel_file_generation_failed %}
            {% set progress_status="REPORT_AVAILABLE" %}
        {% else %}
            {% set progress_status="REPORT_CREATION_FAILED" %}
        {% endif %}
    {% endif %}
{% endif %}
{% endif %}

<div class="container-fluid  mt-0 ">
    
    <div class="row" style="height: 76vh;">

        {#                  #}
        {# LEFT HAND PANEL #}
        {#                  #}

        <div class="col-9" style="padding-left: 1vh; padding-right: 0.5vh;">
            
            <div class="card" style="height: 72vh; margin-top:1vh; overflow:auto">
                <!-- <div class="panel"> -->
                
                <!-- <div class="card-body" style="font-size: 1em;"> -->
                    <!-- <span style="height:4vh; margin-top:1vh; font-size: 1.2em;">Based on your settings for "Context" and "Mode", the following suite of checks will be run:</span> -->
                    <table class="table table-bordered" style="font-size:1.2em">
                        <thead>
                            <!-- add the row of column titles -->
                            <tr>
                                <th class="w-50" scope="col">Set Check</th>
                                <th class="w-25" scope="col">Run Status</th>
                                <th class="w-25" scope="col">Set Rating(s)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for setchk in setchks_session.selected_setchks %}
                                {% set sc=setchk.setchk_code %}
                                {% set setchk_run_status = setchks_session.setchks_run_status[sc] %}
                                <tr style="margin-top: 0em;">
                                    <td> {{ setchk.setchk_short_name_plus_short_code }}</td>
                                    <td> 
                                        <!-- {{ setchk_run_status }}  -->
                                        {% if setchk_run_status=="started" %}
                                            <span class="run_status_blinking"> 
                                            <b>Running..</b> 
                                            </span>
                                        {% else %}
                                            <span class="run_status_static"> 
                                            {% if setchk_run_status=="queued" %}
                                                In queue    
                                            {% elif setchk_run_status=="finished" %}
                                                <b>Completed</b>
                                            {% elif setchk_run_status=="failed" %}
                                                <i><a href="rq?action=failed_jobs">Job failed</a></i>
                                            {% elif 
                                                (not setchks_session.passes_gatekeeper) 
                                                and (setchks_session.setchks_to_run_as_gatekeeper_not_passed != [])
                                                and (sc not in setchks_session.setchks_to_run_as_gatekeeper_not_passed) 
                                                %}
                                                <i>Will not be run</i> 
                                            {% else %}
                                                Ready to run
                                            {% endif %}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set RAG_colors={
                                            "RED":"#ff0000",
                                            "AMBER": "#ffaa00",
                                            "GREEN": "#009f3b",
                                            }
                                        %}
                                        {% if sc in setchks_session.setchks_results %}
                                            {% for sltr in setchks_session.setchks_results[sc].set_level_table_rows %}
                                                {% if sltr.simple_message != None %}
                                                    {% set RAG_rating=sltr.simple_message.split()[0][1:-1] %}
                                                    {% set RAG_color=RAG_colors[RAG_rating] %}
                                                    <i class="bi bi-circle-fill" style="color:{{ RAG_color }}" ></i>
                                                    {{ RAG_rating }}
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                            
                        
                        </tbody>
                    </table>

                    {% if progress_status in [
                        "CHECKS_COMPLETED",
                        "CREATING_REPORT",
                        "REPORT_AVAILABLE",
                        "REPORT_CREATION_FAILED"
                        ] %}

                    <table class="table table-bordered" style="font-size:1.2em">
                        <thead>
                            <!-- add the row of column titles -->
                            <tr>
                                <th scope="col">Task</th>
                                <th scope="col">Run Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td> Create Excel Output</td>
                                <td>
                                {% set generate_run_status = setchks_session.setchks_run_status["GENERATE_EXCEL"] %}
                                {% if generate_run_status=="started" %}
                                    <span class="run_status_blinking"> 
                                    <b>Creating..</b> 
                                    </span>
                                {% else %}
                                    <span class="run_status_static"> 
                                    {% if generate_run_status=="queued" %}
                                        In queue 
                                    {% elif generate_run_status=="finished" %}
                                        <b>Ready</b>
                                    {% elif generate_run_status=="failed" %}
                                        <i><a href="rq?action=failed_jobs">Job failed</a></i>
                                    {% endif %}
                                    </span>
                            {% endif %}
                                </td>

                            </tr>
                        </tbody>
                    </table>
                    {% endif %}



                       
                <!-- </div> -->
            </div>

        </div>

        {#                  #}
        {# RIGHT HAND PANEL #}
        {#                  #}

        <div class="col-3" style="padding-left: 0.5vh; padding-right: 1.0vh;">

            <style>
            .setchks-btn-green {
                background-color: #007f3b;
                color: white;
                border-style: solid;
                border-width: 3px;
                border-color: black;
                }

                .setchks-btn-green:hover {
                background-color: #005f1b;
                color: white;
                border-style: solid;
                border-width: 3px;
                border-color: black;
                }
            </style>
            



            <style>

                .custom-file-upload {
                   
                    display: inline-block;
                    cursor: pointer;
                    /* width: 30vw;  */
                    /* width: 400px;  */
                    width: 100%; 
                    /* height: 130px; */
                    height: 14vh;
                    margin: 5 auto; 
                    border-style: solid;
                    border-width: 3px;
                    border-color: #005eb8;
                    background-color: white; 
                    border-radius: 20px; 
                    font-size: 2em; 
                    line-height: 2em; 
                    padding: 1vh 1vh; 
                    /* padding: 20px 20px;  */
                    text-align: center; 
                    /* color: */
                }
                .custom-file-upload:hover { background-color: #ffeb3b;} 
                .custom-file-upload:active { background-color: #ffeb3b; }

            </style>


            <!-- <style>
                .upload-methods > div {
                    display: block;
                    vertical-align: top;
                    margin-right: 1em;
                    padding-bottom: 1em ;
                    }
            </style> -->
            
            <div>   
                <!-- <div  style="display: inline-block; vertical-align: top; margin-right: 1em;">    -->

                <div style="height:1vh;"></div>
                <div 
                    class="custom-file-upload"
                    {% if progress_status=="CHECKS_READY_TO_RUN" %}
                        style="background-color:#007f3b; color: white"   
                        onclick="window.location.href='/select_and_run_checks?run_checks=True'"
                    {% else %}
                        style="background-color:white; color: grey; border-color: grey;"                                           
                    {% endif %}
                    >
                    <i class="bi bi-play-btn-fill"></i>
                    Run checks
                    <div style="font-size: .6em; line-height: 1.3em;"> 
                        (and create report)
                    </div>
                </div>

                {% if setchks_session.setchks_jobs_manager.jobs_running %}
                    <script>
                        setTimeout(function() { window.location='/select_and_run_checks'; }, 1000);
                    </script>
                {% endif %}
                {% if (not setchks_session.setchks_jobs_manager.jobs_running) and 
                    results_available and (not setchks_session.excel_file_available) %}
                    <!-- <a href="" id="generate_excel_button" class="btn setchks-btn-green">Create Report</a> -->
                    <script>
                        setTimeout(function() { window.location='/select_and_run_checks?generate_report=True'; }, 1000);
                    </script>
                    {% endif %}
                <div style="height:1vh;"></div>
                <div 
                    class="custom-file-upload"
                    {% if progress_status=="REPORT_AVAILABLE" %}
                        style="background-color:#007f3b; color: white"   
                        onclick="window.location.href='/select_and_run_checks?download_report=True'"
                    {% else %}
                        style="background-color:white; color: grey; border-color: grey;"                                           
                    {% endif %}>
                    <i class="bi bi-cloud-download-fill"></i>
                    Download Report
                </div>

            </div>
            <!-- <div style="height:1vh;"></div> -->
            <div class="card" style="height: 42vh; margin-top:1vh; overflow:auto">
                <div class="card-body" style="font-size: 1em;">
                    <!-- <div style="font-size:1.6em;"> 
                        Stage:
                    </div>
                    <ul>
                        {% for status_required, words in [
                            ("CHECKS_READY_TO_RUN","Checks ready to run"),
                            ("CHECKS_RUNNING","Checks running"),
                            ("CHECKS_COMPLETED","Checks completed"),
                            ("CREATING_REPORT","Creating report"),
                            ("REPORT_AVAILABLE","Report available"),
                            ] %}
                            {% set blinking_style = "" %}
                            {% if progress_status==status_required %}
                                {% set list_item="<b>" + words + "</b>" %}
                                {% if progress_status in ["CHECKS_RUNNING", "CREATING_REPORT"] %}
                                    {% set blinking_style = "run_status_blinking" %}
                                {% endif %}
                            {% else %}
                                {% set list_item='<span style="color: grey"><i>' + words + '</i></span>' %}
                            {% endif %}
                            
                            <li class="{{ blinking_style }}" style="font-size:1.4em" >{{ list_item|safe }}</li>
                        {% endfor %}
                    </ul> -->
               
                    <ul>
                        {% if setchks_session.setchks_jobs_manager.jobs_running %}
                            <!-- <a href="/select_and_run_checks" id="jobs_running_button" class="btn setchks-btn">Job(s) running - click to refresh run statuses</a>
                            <script>
                                setTimeout(function() { window.location=$('#jobs_running_button').attr("href"); }, 3000);
                            </script> -->
                            <div>
                                Please do not navigate away from this page while jobs are running (safeguards TBI)
                            </div>
                                {% endif %}
                        {% if setchks_session.passes_gatekeeper==False %}
                        <div style="font-weight: bold; color: red"
                        <b> [Alert] It has been detected that some of the Identifiers in your value set 
                            do not meet certain basic criteria.
                        A set of basic checks will be run, which will provide information on the problematic entries. 
                        No other checks will be run until these entries are corrected or removed from your file, and the file is reloaded.</b>
                        {% endif %}

                    </ul>
                </div>
            </div>
        </div>
    </div>
 
    
</div>

  
{% endblock %}
